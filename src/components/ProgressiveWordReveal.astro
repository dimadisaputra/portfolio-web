---
// src/components/ProgressiveWordReveal.astro
interface Props {
  text: string;
  class?: string;
}

const { text, class: customClass = "" } = Astro.props;
const words = text
  .split(" ")
  .map((word) => `<span class="word">${word}</span>`)
  .join(" ");
---

<p
  class={`progressive-reveal-container flex flex-wrap gap-1 ${customClass}`}
  set:html={words}
/>

<style is:global>
  @reference "../styles/global.css";
  .progressive-reveal-container .word {
    @apply text-gray-400 opacity-50 translate-y-1 transition-all duration-500 ease-out;
  }
  .progressive-reveal-container .word.is-revealed {
    @apply text-gray-700 opacity-100 translate-y-0;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const containers = document.querySelectorAll<HTMLElement>(
      ".progressive-reveal-container"
    );
    if (containers.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const target = entry.target as HTMLElement;
          const words = target.querySelectorAll("span.word");
          if (words.length === 0) return;

          // Ketika fully visible, reveal semua
          if (entry.intersectionRatio >= 0.9) {
            words.forEach((word) => {
              word.classList.add("is-revealed");
            });
            return;
          }

          // Progressive reveal berdasarkan scroll position
          const progress = Math.max(0, Math.min(entry.intersectionRatio, 1));
          const wordCount = words.length;
          const wordsToShow = Math.ceil(progress * wordCount);

          words.forEach((word, index) => {
            if (index < wordsToShow) {
              word.classList.add("is-revealed");
            }
          });
        });
      },
      {
        root: null,
        rootMargin: "0px 0px -5% 0px",
        threshold: Array.from({ length: 101 }, (_, i) => i / 100),
      }
    );

    containers.forEach((container) => {
      observer.observe(container);
    });
  });
</script>
